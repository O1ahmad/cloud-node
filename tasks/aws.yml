---
- name: Create a security group
  community.aws.ec2_group:
    name: "{{ security_group_name }}"
    description: "{{ security_group_description }}"
    region: "{{ region }}"
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    rules:
      - proto: "{{ item.protocol }}"
        from_port: "{{ item.port }}"
        to_port: "{{ item.port }}"
        cidr_ip: "{{ item.cidr }}"
    state: present
  with_items: "{{ ingress_ports }}"
  register: security_group

- name: Create an EC2 instance
  community.aws.ec2_instance:
    name: "{{ instance_tag }}"
    instance_type: "{{ instance_type }}"
    region: "{{ region }}"
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    image_id: "{{ ami_id }}"
    wait: true
    instance_tags:
      Name: "{{ instance_tag }}"
    volumes:
      - device_name: /dev/sda1
        volume_size: "{{ storage_size }}"
    network:
      assign_public_ip: "{{ public_ip }}"
      groups: "{{ security_group.group_id }}"
  register: ec2

- name: Wait for the instance to be reachable via SSH
  ansible.builtin.wait_for:
    host: "{{ ec2.instances[0].public_ip_address }}"
    port: 22
    delay: 60
    timeout: 320
    state: started

- name: Add instance to inventory
  ansible.builtin.add_host:
    name: "{{ ec2.instances[0].public_ip_address }}"
    groups: "{{ instance_tag }}"
    ansible_host: "{{ ec2.instances[0].public_ip_address }}"
    ansible_user: ec2-user
    ansible_ssh_private_key_file: "{{ ssh_private_key_path }}"
